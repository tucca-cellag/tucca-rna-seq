---
title: "Interactive Exploration of tucca-rna-seq Results"
author: "Workflow User (Analyst: Ben Bromberg)"
date: "2025-05-29 15:33:41 UTC" # Updated with provided timestamp
output:
  html_document:
    toc: true
    toc_float: true
    theme: yeti
    highlight: tango
editor_options: 
  markdown: 
    wrap: 80
---

## Introduction

This R Markdown document provides a centralized interface to launch various
interactive Shiny applications for exploring the results from the
`tucca-rna-seq` workflow.

**This project uses `renv` for R package management to ensure reproducibility.**

**Before You Begin (First-Time Setup / New Collaborators):**

1.  Open the RStudio Project (e.g., by double-clicking the `.Rproj` file if you
    have one) or open R/RStudio with the working directory set to the
    **project's root**.
2.  `renv` should automatically activate upon opening the project in R/RStudio.
3.  **Check the R Console:** If your project library isn't yet built or is out
    of sync with `renv.lock`, `renv` will likely print a message prompting you
    to run `renv::restore()`.
4.  If prompted (or if you know the environment isn't set up), type
    `renv::restore()` in the R console and follow the instructions. This will
    install all the exact package versions specified in `renv.lock` into a
    project-specific library. This step might take some time.
5.  Once `renv::restore()` is complete, you can proceed to use this R Markdown
    document.

**Subsequent Sessions:** `renv` will automatically use the project-specific
library. If `renv.lock` is updated (e.g., after pulling changes from Git),
`renv` will again prompt you to run `renv::restore()` to synchronize.

--------------------------------------------------------------------------------

## 1. Setup: Packages and Configuration

### 1.1. Required Packages (Managed by `renv`)

The R packages needed for this analysis are managed by `renv` and defined in the
`renv.lock` file. If you have successfully run `renv::restore()` as described in
the Introduction, these packages should already be installed in your project's
private library.

This list serves as documentation for the project's direct R dependencies:

-   **Core & Common:** `DESeq2`, `SummarizedExperiment`, `shiny`, `DT`, `dplyr`,
    `readr`, `ggplot2`
-   **pcaExplorer:** `pcaExplorer`
-   **ideal:** `ideal`, `ReportingTools`, `Glimma`
-   **GeneTonic & Enrichment:** `GeneTonic`, `clusterProfiler`, `AnnotationDbi`,
    `enrichplot`
-   **Organism-Specific Annotation Databases (Examples):** `org.Hs.eg.db`
    (Human), `org.Mm.eg.db` (Mouse) - *Ensure the one relevant to your data is
    listed in `renv.lock` and restored.*

You typically do not need to run `install.packages()` or
`BiocManager::install()` commands here if `renv::restore()` was successful. If
you need to add or update packages for the project, do so and then run
`renv::snapshot()` to update the lockfile.

### 1.2. Load Common Libraries

```{r setup-load-libraries, message=FALSE, warning=FALSE}
# These libraries are loaded in each session after being installed via
# renv::restore().
library(DESeq2)
library(SummarizedExperiment)
library(dplyr)
library(readr)
```

### 1.3. User Configuration: Define Analysis, Contrast, and Annotation

**IMPORTANT: Please modify the variables in this chunk to point to your desired
dataset.**

```{r user-configuration}
# --- VVV USER INPUT REQUIRED VVV ---

# 1. Name of the DESeq2 analysis (this is a subfolder in 'resources/deseq2/')
selected_analysis_name <- "YOUR_ANALYSIS_NAME_HERE" # e.g., "all_samples_condition"

# 2. Name of the contrast for differential expression results
selected_contrast_name <- "YOUR_CONTRAST_NAME_HERE" # e.g., "groupA_vs_groupB"

# 3. (Optional but Recommended) Path to your gene annotation RDS file (relative to project root).
annotation_rds_path <- NULL # e.g., "workflow/annotations/human_ensembl_to_symbol.RDS"

# 4. (For GeneTonic Enrichment) Organism annotation database package name.
organism_db_pkg_name <- NULL # e.g., "org.Hs.eg.db"

# 5. (For GeneTonic Enrichment) Keytype for gene IDs used in enrichment.
enrichment_keytype <- "ENSEMBL"

# --- ^^^ END USER INPUT ^^^ ---

# --- Validate Configuration & Construct Paths ---
if (selected_analysis_name == "YOUR_ANALYSIS_NAME_HERE" || selected_contrast_name == "YOUR_CONTRAST_NAME_HERE") {
  stop("CRITICAL: Please update 'selected_analysis_name' and 'selected_contrast_name' in the 'User Configuration' chunk (Section 1.3).")
}
dds_file_path <- file.path("resources/deseq2", selected_analysis_name, "dds.RDS")
de_results_path <- file.path("resources/deseq2", selected_analysis_name, selected_contrast_name, "dge.tsv")

message("---------------------------------------------------------")
message("Configuration Summary:")
message("Analysis Name: ", selected_analysis_name)
message("Contrast Name: ", selected_contrast_name)
message("DDS File Path: ", dds_file_path)
message("DE Results Path: ", de_results_path)
message("Annotation RDS: ", ifelse(is.null(annotation_rds_path), "Not provided", annotation_rds_path))
message("Organism DB for Enrichment: ", ifelse(is.null(organism_db_pkg_name), "Not specified", organism_db_pkg_name))
message("Keytype for Enrichment: ", enrichment_keytype)
message("---------------------------------------------------------")
```

--------------------------------------------------------------------------------

## 2. Load Core Data Objects

This section loads the `DESeqDataSet` (dds), annotation (if provided), and the
differential expression (DE) results table based on your configuration above.

```{r load-core-data, message=TRUE, warning=TRUE}
# Load DESeqDataSet (dds)
if (!file.exists(dds_file_path)) {
  stop("DDS file not found: ", dds_file_path, ". Please check your 'selected_analysis_name' and ensure the workflow has completed and renv environment is active.")
}
dds <- readRDS(dds_file_path)
message("Successfully loaded DESeqDataSet (dds) with ", nrow(dds), " genes and ", ncol(dds), " samples.")
colData(dds) <- S4Vectors::DataFrame(lapply(as.data.frame(colData(dds)), function(x) if (is.character(x)) factor(x) else x))

# Load Annotation Object (annotation_obj)
annotation_obj <- NULL
if (!is.null(annotation_rds_path)) {
  if (file.exists(annotation_rds_path)) {
    annotation_obj <- readRDS(annotation_rds_path)
    message("Successfully loaded annotation object with ", nrow(annotation_obj), " entries.")
    if (!"gene_name" %in% colnames(annotation_obj)) {
      warning("Annotation object loaded, but it does NOT contain a 'gene_name' column.")
    }
  } else {
    warning("Annotation RDS file specified but NOT FOUND at: ", annotation_rds_path)
  }
} else {
  message("No custom annotation RDS path provided.")
  annotation_obj <- data.frame(row.names = rownames(dds))
  annotation_obj$gene_name <- rownames(dds)
  message("Created a minimal annotation_obj using rownames from DDS as 'gene_name'.")
}

# Load Differential Expression Results (res_df)
if (!file.exists(de_results_path)) {
  stop("DE results file (dge.tsv) not found: ", de_results_path)
}
res_df <- readr::read_tsv(de_results_path, col_types = readr::cols())
res_df <- as.data.frame(res_df)
if (ncol(res_df) > 0 && (colnames(res_df)[1] %in% c("X1", "...1", "feature_id", "gene_id") || !all(is.na(suppressWarnings(as.numeric(rownames(res_df))))))) {
  if (length(unique(res_df[[1]])) == nrow(res_df)) {
    rownames(res_df) <- res_df[[1]]
  }
}
message("Successfully loaded DE results (res_df) with ", nrow(res_df), " entries for contrast: '", selected_contrast_name, "'.")

common_genes <- intersect(rownames(dds), rownames(res_df))
if (length(common_genes) < nrow(res_df) || length(common_genes) < nrow(dds)) {
  message("Subsetting DE results to ", length(common_genes), " common genes found in DDS.")
}
res_df <- res_df[common_genes, , drop = FALSE] # Ensure it's still a data.frame

res_DESeqResults <- NULL
required_deseq_cols <- c("baseMean", "log2FoldChange", "lfcSE", "pvalue", "padj")
if (all(required_deseq_cols %in% colnames(res_df))) {
  res_DESeqResults <- DESeqResults(S4Vectors::DataFrame(res_df)) # Use the already subsetted res_df
  message("Created a DESeqResults object ('res_DESeqResults') from the DE table.")
} else {
  warning("Could not create a formal DESeqResults object as some standard columns (baseMean, log2FoldChange, lfcSE, pvalue, padj) are missing in res_df.")
}
```

--------------------------------------------------------------------------------

## 3. `pcaExplorer`: Interactive PCA Plots

*Key Inputs: `dds`, `annotation_obj` (optional).*

```{r launch-pcaExplorer, eval=FALSE, R.options=list(width=120)}
# Ensure pcaExplorer is loaded (it should be if renv::restore() was successful)
library(pcaExplorer)
message("Launching pcaExplorer for analysis: '", selected_analysis_name, "'...")
pcaExplorer(dds = dds, annotation = annotation_obj)
```

--------------------------------------------------------------------------------

## 4. `ideal`: Interactive Differential Expression Analysis

*Key Inputs: `dds`, `res_DESeqResults` or `res_df`, `annotation_obj`
(optional).*

```{r launch-ideal, eval=FALSE, R.options=list(width=120)}
library(ideal)
message("Launching ideal for contrast: '", selected_contrast_name, "' from analysis: '", selected_analysis_name, "'...")
current_de_results_for_ideal <- if (!is.null(res_DESeqResults)) res_DESeqResults else res_df
ideal(
  dds_object = dds,
  res_object = current_de_results_for_ideal,
  annotation_obj = annotation_obj,
  FDR = 0.05,
  project_name = paste("ideal report:", selected_analysis_name, "-", selected_contrast_name)
)
```

--------------------------------------------------------------------------------

## 5. `GeneTonic`: Visualize DE Genes & Enrichment Results

*Key Inputs: `dds`, `res_df` or `res_DESeqResults`, `res_enrich` (enrichment
results table), `annotation_obj`.*

**`GeneTonic` requires enrichment analysis results (`res_enrich`).** Section 5.1
provides an example of how to generate these.

### 5.1. (Optional) Generate Enrichment Results (`res_enrich`)

Run this chunk if you need to perform functional enrichment analysis. This
example uses `clusterProfiler` for GSEA with GO terms.

```{r generate-enrichment-optional, eval=FALSE, R.options=list(width=120)}
res_enrich_gsea_df <- NULL # Initialize
if (is.null(organism_db_pkg_name) || organism_db_pkg_name == "") {
  warning("Organism database ('organism_db_pkg_name') not specified in Configuration (Section 1.3). Cannot perform enrichment.")
} else {
  # Load libraries for enrichment if not already loaded
  library(clusterProfiler)
  library(organism_db_pkg_name, character.only = TRUE)

  message("Preparing gene list for GSEA using '", organism_db_pkg_name, "' and keytype '", enrichment_keytype, "'...")
  if (!"log2FoldChange" %in% colnames(res_df)) {
    stop("Column 'log2FoldChange' not found in res_df. Cannot prepare gene list for GSEA.")
  }
  gene_list_df_for_gsea <- res_df[!is.na(res_df$log2FoldChange) & !is.na(rownames(res_df)), ]
  gene_list_df_for_gsea <- gene_list_df_for_gsea[!duplicated(rownames(gene_list_df_for_gsea)), ]
  gene_list_ranked <- gene_list_df_for_gsea$log2FoldChange
  names(gene_list_ranked) <- rownames(gene_list_df_for_gsea)
  gene_list_ranked <- sort(gene_list_ranked, decreasing = TRUE)

  if (length(gene_list_ranked) == 0) {
    stop("Gene list for GSEA is empty after filtering.")
  }
  message("Ranked gene list prepared with ", length(gene_list_ranked), " genes.")

  message("Running Gene Set Enrichment Analysis (GSEA) with gseGO...")
  gse_results_obj <- gseGO(
    geneList = gene_list_ranked,
    OrgDb = get(organism_db_pkg_name),
    keyType = enrichment_keytype,
    ont = "BP",
    minGSSize = 10,
    maxGSSize = 500,
    pvalueCutoff = 0.05,
    pAdjustMethod = "BH",
    verbose = TRUE,
    eps = 1e-30
  )

  if (is.null(gse_results_obj) || nrow(gse_results_obj@result) == 0) {
    warning("GSEA with gseGO did not return any significant results.")
  } else {
    message("GSEA completed. ", nrow(gse_results_obj@result), " terms found.")
    res_enrich_gsea_df <- as.data.frame(gse_results_obj@result)
  }
}
# For pre-computed results:
# if (is.null(res_enrich_gsea_df) && file.exists("path/to/my_enrichment_results.RDS")) {
#   res_enrich_gsea_df <- readRDS("path/to/my_enrichment_results.RDS")
#   message("Loaded pre-computed enrichment results.")
# }
```

### 5.2. Launch `GeneTonic`

```{r launch-GeneTonic, eval=FALSE, R.options=list(width=120)}
library(GeneTonic)
current_enrich_results_for_gt <- if (exists("res_enrich_gsea_df") && !is.null(res_enrich_gsea_df) && nrow(res_enrich_gsea_df) > 0) {
  res_enrich_gsea_df
} else {
  NULL
}

if (is.null(current_enrich_results_for_gt)) {
  warning("Enrichment results are NULL or empty. GeneTonic will have limited functionality or may not launch.")
} else {
  message("Launching GeneTonic with DE results and enrichment data...")
  gt_annotation <- annotation_obj
  if (!"gene_id" %in% colnames(gt_annotation)) gt_annotation$gene_id <- rownames(gt_annotation)
  if (!"gene_name" %in% colnames(gt_annotation)) gt_annotation$gene_name <- gt_annotation$gene_id

  GeneTonic(
    dds = dds,
    res_de = if (!is.null(res_DESeqResults)) res_DESeqResults else res_df,
    res_enrich = current_enrich_results_for_gt,
    annotation_obj = gt_annotation,
    project_id = paste0("GeneTonic :: ", selected_analysis_name, " :: ", selected_contrast_name)
  )
}
```
